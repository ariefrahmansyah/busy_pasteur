name: "Create cluster using KinD"
on: [pull_request, push]

jobs:
  kind:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    # - uses: engineerd/setup-kind@v0.4.0
    #   with:
    #     version: "v0.8.1"
    #     config: kind-config.yaml
    - name: Setup Kind
      run: |
        kind create cluster --config=kind-config.yaml
    - name: Install Nginx Ingress Controller 
      run: |
        kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/kind/deploy.yaml
        kubectl config set-context $(kubectl config current-context) --namespace=ingress-nginx
        sleep 15
        kubectl get pods
        sleep 15
        kubectl get pods
        POD=$(kubectl get pod -l app.kubernetes.io/name=ingress-nginx,app.kubernetes.io/component=controller -o jsonpath={.items[0].metadata.name})
        kubectl describe pod $POD
        kubectl wait --namespace ingress-nginx \
          --for=condition=ready pod \
          --selector=app.kubernetes.io/component=controller \
          --timeout=90s
    - name: Test Ingress
      run: |
        kubectl apply -f test-ingress.yaml
        sleep 5
        kubectl get all,ingress
        sleep 30
        kubectl get all,ingress
        curl localhost/foo
        curl localhost/bar